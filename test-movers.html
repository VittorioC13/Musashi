<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Musashi Market Movers Tester</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      max-width: 1200px;
      margin: 40px auto;
      padding: 20px;
      background: #f5f5f5;
    }
    h1 {
      color: #1a1a1a;
      margin-bottom: 10px;
    }
    .subtitle {
      color: #666;
      margin-bottom: 30px;
    }
    .controls {
      background: white;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 20px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    label {
      display: inline-block;
      margin-right: 10px;
      font-weight: 600;
    }
    input, select, button {
      padding: 8px 12px;
      border: 1px solid #ddd;
      border-radius: 4px;
      margin-right: 10px;
    }
    button {
      background: #4CAF50;
      color: white;
      border: none;
      cursor: pointer;
      font-weight: 600;
    }
    button:hover {
      background: #45a049;
    }
    .refresh-btn {
      background: #2196F3;
    }
    .refresh-btn:hover {
      background: #1976D2;
    }
    #loading {
      color: #666;
      font-style: italic;
    }
    #results {
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .mover {
      padding: 15px;
      margin-bottom: 12px;
      background: #FAFAFA;
      border-radius: 6px;
      border-left: 4px solid;
      transition: transform 0.2s;
    }
    .mover:hover {
      transform: translateX(4px);
    }
    .mover.up {
      border-left-color: #4CAF50;
      background: linear-gradient(to right, #E8F5E9 0%, #FAFAFA 20%);
    }
    .mover.down {
      border-left-color: #F44336;
      background: linear-gradient(to right, #FFEBEE 0%, #FAFAFA 20%);
    }
    .mover-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }
    .mover-title {
      font-weight: 600;
      color: #1a1a1a;
      flex: 1;
    }
    .price-change {
      font-size: 24px;
      font-weight: bold;
      margin-left: 15px;
    }
    .price-change.up {
      color: #2E7D32;
    }
    .price-change.down {
      color: #C62828;
    }
    .mover-meta {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 10px;
      margin-top: 10px;
      font-size: 14px;
      color: #666;
    }
    .meta-item {
      display: flex;
      align-items: center;
      gap: 5px;
    }
    .price-info {
      background: rgba(0,0,0,0.05);
      padding: 8px 12px;
      border-radius: 4px;
      margin-top: 10px;
      font-size: 13px;
    }
    .no-results {
      text-align: center;
      padding: 40px;
      color: #666;
    }
    .stats {
      display: flex;
      gap: 20px;
      margin-bottom: 20px;
    }
    .stat-card {
      flex: 1;
      background: white;
      padding: 15px;
      border-radius: 6px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      text-align: center;
    }
    .stat-value {
      font-size: 32px;
      font-weight: bold;
      color: #4CAF50;
      margin-bottom: 5px;
    }
    .stat-label {
      font-size: 14px;
      color: #666;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
  </style>
</head>
<body>
  <h1>üìà Musashi Market Movers</h1>
  <p class="subtitle">Track markets with significant price changes</p>

  <div class="controls">
    <label>Min Change:</label>
    <input type="number" id="minChange" value="0.05" step="0.01" min="0" max="1">

    <label>Timeframe:</label>
    <select id="timeframe">
      <option value="1h" selected>1 Hour</option>
      <option value="6h">6 Hours</option>
      <option value="24h">24 Hours</option>
    </select>

    <label>Limit:</label>
    <input type="number" id="limit" value="20" min="1" max="100">

    <button onclick="fetchMovers(false)">Get Movers</button>
    <button class="refresh-btn" onclick="fetchMovers(true)">Force Refresh</button>
    <span id="loading" style="display:none;">Loading...</span>
  </div>

  <div id="stats" style="display:none;"></div>
  <div id="results"></div>

  <script>
    async function fetchMovers(forceRefresh = false) {
      const minChange = parseFloat(document.getElementById('minChange').value);
      const timeframe = document.getElementById('timeframe').value;
      const limit = parseInt(document.getElementById('limit').value);
      const loading = document.getElementById('loading');
      const results = document.getElementById('results');
      const stats = document.getElementById('stats');

      loading.style.display = 'inline';
      results.innerHTML = '';
      stats.style.display = 'none';

      try {
        const response = await chrome.runtime.sendMessage({
          type: 'GET_MOVERS',
          minChange: minChange,
          timeframe: timeframe,
          limit: limit,
          forceRefresh: forceRefresh
        });

        loading.style.display = 'none';

        const movers = response.movers || [];

        if (movers.length === 0) {
          results.innerHTML = '<div class="no-results">No movers found with current filters.<br><br>Try lowering the minimum change threshold or wait for price data to accumulate.</div>';
          return;
        }

        // Calculate stats
        const upMovers = movers.filter(m => m.direction === 'up').length;
        const downMovers = movers.filter(m => m.direction === 'down').length;
        const avgChange = movers.reduce((sum, m) => sum + Math.abs(m.priceChange1h), 0) / movers.length;

        stats.style.display = 'flex';
        stats.innerHTML = `
          <div class="stat-card">
            <div class="stat-value">${movers.length}</div>
            <div class="stat-label">Total Movers</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" style="color: #4CAF50;">‚Üë ${upMovers}</div>
            <div class="stat-label">Moving Up</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" style="color: #F44336;">‚Üì ${downMovers}</div>
            <div class="stat-label">Moving Down</div>
          </div>
          <div class="stat-card">
            <div class="stat-value">${(avgChange * 100).toFixed(1)}%</div>
            <div class="stat-label">Avg Change</div>
          </div>
        `;

        results.innerHTML = `
          <h2 style="margin: 0 0 20px 0; color: #333;">Market Movers (${movers.length})</h2>
          ${movers.map((mover, idx) => `
            <div class="mover ${mover.direction}">
              <div class="mover-header">
                <span style="color: #666; font-weight: 600;">#${idx + 1}</span>
                <div class="mover-title">${mover.market.title}</div>
                <div class="price-change ${mover.direction}">
                  ${mover.direction === 'up' ? '‚Üë' : '‚Üì'} ${(Math.abs(mover.priceChange1h) * 100).toFixed(1)}%
                </div>
              </div>

              <div class="price-info">
                <strong>Price Movement:</strong>
                ${(mover.previousPrice * 100).toFixed(0)}% ‚Üí ${(mover.currentPrice * 100).toFixed(0)}% YES
                ${mover.priceChange24h !== 0 ? `
                  <span style="margin-left: 15px;">24h: ${mover.priceChange24h > 0 ? '+' : ''}${(mover.priceChange24h * 100).toFixed(1)}%</span>
                ` : ''}
              </div>

              <div class="mover-meta">
                <div class="meta-item">
                  <span>üìä</span>
                  <span>Volume: ${formatVolume(mover.market.volume24h)}</span>
                </div>
                <div class="meta-item">
                  <span>üè∑Ô∏è</span>
                  <span>${mover.market.platform}</span>
                </div>
                <div class="meta-item">
                  <span>üìÅ</span>
                  <span>${mover.market.category}</span>
                </div>
                <div class="meta-item">
                  <span>‚è∞</span>
                  <span>${formatTime(mover.timestamp)}</span>
                </div>
              </div>
            </div>
          `).join('')}
        `;

      } catch (error) {
        loading.style.display = 'none';
        results.innerHTML = `<div class="no-results">Error: ${error.message}<br><br>Make sure the Musashi extension is installed and running.<br><br>Note: Price history needs time to accumulate. If you just installed the extension, wait a few minutes for snapshots to be recorded.</div>`;
        console.error('Movers fetch error:', error);
      }
    }

    function formatVolume(volume) {
      if (volume >= 1000000) {
        return `$${(volume / 1000000).toFixed(1)}M`;
      } else if (volume >= 1000) {
        return `$${(volume / 1000).toFixed(0)}K`;
      }
      return `$${volume.toFixed(0)}`;
    }

    function formatTime(timestamp) {
      const now = Date.now();
      const diff = now - timestamp;
      const minutes = Math.floor(diff / 60000);

      if (minutes < 1) return 'Just now';
      if (minutes === 1) return '1 min ago';
      if (minutes < 60) return `${minutes} mins ago`;

      const hours = Math.floor(minutes / 60);
      if (hours === 1) return '1 hour ago';
      if (hours < 24) return `${hours} hours ago`;

      const days = Math.floor(hours / 24);
      if (days === 1) return '1 day ago';
      return `${days} days ago`;
    }

    // Auto-fetch on page load (after a delay to let extension initialize)
    window.addEventListener('load', () => {
      setTimeout(() => fetchMovers(false), 1000);
    });

    // Auto-refresh every 2 minutes
    setInterval(() => {
      console.log('Auto-refreshing movers...');
      fetchMovers(false);
    }, 2 * 60 * 1000);
  </script>
</body>
</html>
